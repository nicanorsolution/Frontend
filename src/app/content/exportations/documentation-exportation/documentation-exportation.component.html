<div class="main-content slit-in-vertical">
  <p-confirmDialog></p-confirmDialog>

  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="header">
            <h4 class="title">Exportation Details</h4>
          </div>
          <div class="content">
            <!-- Loading State -->
            <div *ngIf="loading" class="flex align-items-center justify-content-center" style="height: 200px;">
              <p-progressSpinner></p-progressSpinner>
            </div>

            <!-- Exportation Details -->
            <div *ngIf="!loading && exportation" class="p-4">
              <p-fieldset legend="Exportation Information">
                <div class="grid">
                  <div class="col-3"><b>Reference:</b></div>
                  <div class="col-3">{{exportation.exportationReference}}</div>
                  <div class="col-3"><b>Status:</b></div>
                  <div class="col-3">
                    <status [value]="getStatusString(exportation.exportationStatus)"
                          [severity]="colorStatus(exportation.exportationStatus)">
                    </status>
                  </div>

                  <div class="col-3"><b>Customer:</b></div>
                  <div class="col-3">{{exportation.customerName}}</div>
                  <div class="col-3"><b>Created Date:</b></div>
                  <div class="col-3">{{exportation.exportationCreatedDate | date:'medium'}}</div>

                  <div class="col-3"><b>Apurement Status:</b></div>
                  <div class="col-3">
                    <status [value]="getApurementStatusString(exportation.exportationApurementStatus)"
                          severity="info">
                    </status>
                  </div>
                  <div class="col-3"><b>Apurement Running (150 days):</b></div>
                  <div class="col-3">
                    <status [value]="exportation.numberDaysSinceDomiciliation.toString() + ' days'"
                          [severity]="exportation.numberDaysSinceDomiciliation < 150 ? 'success' : 'danger'">
                    </status>
                  </div>
                    <div class="col-3"><b>Exportation Exception Count:</b></div>
                    <div class="col-3">
                        <a *ngIf="!exportation.exportationExceptionsPendingCount || exportation.exportationExceptionsPendingCount === 0" >
                          <status value="0 Exception(0) pending" severity="success"></status>
                        </a>
                        <a *ngIf="exportation.exportationExceptionsPendingCount > 0">
                          <status [value]="exportation.exportationExceptionsPendingCount.toString() + ' Exception(s) pending'" severity="danger"></status>
                        </a>
                    </div>
                </div>
              </p-fieldset>
              <br/>
              <p-fieldset legend="DE Details" class="mt-3">
                <div class="grid">
                  <div class="col-3"><b>eForce Reference:</b></div>
                  <div class="col-3">{{exportation.deDetails.eForceReference}}</div>
                  <div class="col-3"><b>File Number:</b></div>
                  <div class="col-3">{{exportation.deDetails.fileNumber}}</div>

                  <div class="col-3"><b>Domiciliation Reference:</b></div>
                  <div class="col-3">{{exportation.deDetails.domiciliationReference}}</div>
                  <div class="col-3"><b>Domiciliation Date:</b></div>
                  <div class="col-3">{{exportation.deDetails.domiciliationDate | date:'mediumDate'}}</div>

                  <div class="col-3"><b>Provider:</b></div>
                  <div class="col-3">{{exportation.deDetails.provider}}</div>
                  <div class="col-3"><b>Buyer:</b></div>
                  <div class="col-3">{{exportation.deDetails.buyer}}</div>

                  <div class="col-3"><b>FOB Value (CFA):</b></div>
                  <div class="col-3">{{exportation.deDetails.fobValueCfa | number:'1.2-2'}}</div>
                  <div class="col-3"><b>Place of Destination:</b></div>
                  <div class="col-3">{{exportation.deDetails.placeOfDestination}}</div>

                  <div class="col-3"><b>Bank DE Domiciliation Date:</b></div>
                  <div class="col-3">{{exportation.deDetails.bankDEDomiciliationDate | date:'mediumDate'}}</div>

                   <div class="col-3"><b>Deadline for Repatriation of Funds:</b></div>
                  <div class="col-3">{{exportation.deDetails.deadLineForRepatriationOfFunds | date:'mediumDate'}}</div>

                  <div class="col-3"><b>DE Emission Date:</b></div>
                  <div class="col-3">{{exportation.deDetails.deEmissionDate | date:'mediumDate'}}</div>

                  <div class="col-3"><b>DE Expiration Date:</b></div>
                  <div class="col-3">{{exportation.deDetails.deExpirationDate | date:'mediumDate'}}</div>

                  <div class="col-3"><b>Exportation Type:</b></div>
                  <div class="col-3">{{exportation.deDetails.exportationType}}</div>

                  <div class="col-3"><b>Full Domiciliation Reference:</b></div>
                  <div class="col-3">{{exportation.deDetails.fullDomiciliationReference}}</div>

                   <div class="col-3"><b>Goods/Services Nature:</b></div>
                  <div class="col-3">{{exportation.deDetails.goodOrServiceNature}}</div>
                </div>
              </p-fieldset>
              <br/>
              <p-fieldset legend="DE Fees Details" class="mt-3">
                <div class="grid">
                  <div class="col-3"><b>Fee Status:</b></div>
                  <div class="col-3">
                    <status [value]="getDEFeeStatusString(exportation.deFeeStatus)"
                          [severity]="colorDEFeeStatus(exportation.deFeeStatus)">
                    </status>
                  </div>
                   <div class="col-3"><b>Amount:</b></div>
                  <div class="col-3">{{exportation.deFeeAmount | number:'1.2-2'}}</div>

                  <div class="col-3"><b>Collection Date:</b></div>
                  <div class="col-3">{{(exportation.deFeeCollectionDate | date:'medium') || 'Not collected'}}</div>

                  <div class="col-3"><b>Collection Message:</b></div>
                  <div class="col-3">{{exportation.deFeeCollectionMessage || 'No message'}}</div>
                </div>
              </p-fieldset>

              <br/>
              <p-fieldset legend="Facture Definitive " class="mt-3">
                <div class="grid">
                  <div class="col-3"><b>Reference Facture Definitive:</b></div>
                  <div class="col-3">{{exportation.referenceFactureDefinitive}}</div>

                  <div class="col-3"><b>Montant Facture Definitive:</b></div>
                  <div class="col-3">{{exportation.amountFactureDefinitive |  number:'1.2-2'}}</div>
                  <div class="col-3"><button pButton label="Clear Facture Definitive" icon="pi pi-times"
                                                class="p-button-danger p-button-outlined p-button-rounded"
                                               appRoleVisibility [requiredRoles]="[UserRoleEnum.TradeDeskAuthorizer]"
                                               (click)="clearFactureDefinitive()">
                                    </button></div>
                </div>
              </p-fieldset>
              <br/>
              <p-fieldset legend="Bon pour Embarquement" class="mt-3">
                <div class="grid">
                  <div class="col-3"><b>Reference Bon pour Embarquement:</b></div>
                  <div class="col-3">{{exportation.referenceBonForEmbarquement}}</div>

                  <div class="col-3"><b>Montant Bon pour Embarquement:</b></div>
                  <div class="col-3">{{exportation.amountBonForEmbarquement | number:'1.2-2'}}</div>

                  <div class="col-3"><b>Date Bon pour Embarquement:</b></div>
                  <div class="col-3">{{exportation.dateBonForEmbarquement | date:'mediumDate'}}</div>
                  <div class="col-3"></div>
                  <div class="col-3"></div>
                  <div class="col-3"><button pButton label="Clear Bon pour Embarquement" icon="pi pi-times"
                                                class="p-button-danger p-button-outlined p-button-rounded"
                                               appRoleVisibility [requiredRoles]="[UserRoleEnum.TradeDeskAuthorizer]"
                                               (click)="clearBonEmbarquement()">
                                    </button></div>
                </div>
              </p-fieldset>
              <br/>
              <!-- Add new Incoming Responses section -->
              <p-fieldset legend="Incomings Matching" class="mt-3">
                <p-table [value]="exportation.incomingResponses" styleClass="p-datatable-gridlines">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Swift Reference</th>
                      <th>Value Date</th>
                      <th>Account</th>
                      <th>Amount</th>
                      <th>Currency</th>
                      <th>Uploaded Date</th>
                      <th>Status</th>
                      <th>
                        Actions
                      </th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-incoming>
                    <tr>
                      <td>{{incoming.incomingSwiftReference}}</td>
                      <td>{{incoming.incomingValueDate | date:'medium'}}</td>
                      <td>{{incoming.incomingAccountNumber}}</td>
                      <td>{{incoming.incomingAmount | number:'1.2-2'}}</td>
                      <td>{{incoming.currency}}</td>
                      <td>{{incoming.incomingDate | date:'medium'}}</td>
                      <td>
                        <status [value]="getIncomingStatusString(incoming.incomingStatus)"
                              [severity]="colorIncomingStatus(incoming.incomingStatus)">
                        </status>
                      </td>
                      <td>
                        <div class="flex gap-2"
                        appRoleVisibility [requiredUserTypes]="[UserType.InternalUser]">

                          <button pButton icon="pi pi-download"
                                  class="p-button-rounded p-button-info"
                                  [disabled]="!incoming.hasIncomingSwiftFilePath"
                                  (click)="downloadIncomingSwift(exportation.id, incoming.serialNumber)"
                                  appRoleVisibility [requiredUserTypes]="[UserType.InternalUser]"
                                  pTooltip="Download Swift">
                          </button>

                          <button pButton icon="pi pi-trash"
                                  class="p-button-rounded p-button-danger"
                                  (click)="deleteIncoming(exportation.id, incoming.serialNumber)"
                                   appRoleVisibility [requiredRoles]="[UserRoleEnum.TradeDeskAuthorizer]"
                                  pTooltip="Delete">
                          </button>
                        </div>
                      </td>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="emptymessage">
                    <tr>
                      <td colspan="8" class="text-center">No incoming responses found</td>
                    </tr>
                  </ng-template>
                </p-table>
              </p-fieldset>
              <br/>
              <!-- Incoming Retrocession section -->
              <p-fieldset legend="Incomings Retrocession" class="mt-3">
                <p-table [value]="exportation.incomingRetrocessionResponses" styleClass="p-datatable-gridlines">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Refund Reference</th>
                      <th>Registration Date</th>
                      <th>Amount</th>
                      <th>Currency</th>
                      <th>Status</th>
                      <th appRoleVisibility [requiredUserTypes]="[UserType.InternalUser]">Actions</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-item>
                    <tr>
                      <td>{{item.refundReference}}</td>
                      <td>{{item.registrationDate | date:'medium'}}</td>
                      <td>{{item.amountThatShouldBeRefund | number:'1.2-2'}}</td>
                      <td>{{item.currency}}</td>
                      <td>
                        <status [value]="getIncomingRetrocessionStatusString(item.incomingRetrocessionStatus)"
                                [severity]="colorIncomingRetrocessionStatus(item.incomingRetrocessionStatus)">
                        </status>
                      </td>
                      <td>
                        <div class="flex gap-2" appRoleVisibility [requiredUserTypes]="[UserType.InternalUser]">
                          <button pButton icon="pi pi-download"
                                  class="p-button-rounded p-button-info"
                                  [disabled]="!item.hasRefundSwiftFilePath"
                                  (click)="downloadIncomingRetrocessionSwift(exportation.id, item.serialNumber)"
                                  pTooltip="Download SWIFT">
                          </button>
                          <button pButton icon="pi pi-trash"
                                  class="p-button-rounded p-button-danger"
                                  (click)="deleteIncomingRetrocession(exportation.id, item.serialNumber)"
                                  appRoleVisibility [requiredRoles]="[UserRoleEnum.TradeDeskAuthorizer]"
                                  pTooltip="Delete">
                          </button>
                        </div>
                      </td>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="emptymessage">
                    <tr>
                      <td colspan="6" class="text-center">No retrocession records found</td>
                    </tr>
                  </ng-template>
                </p-table>
              </p-fieldset>

              <!--  Exportation review and actions : exceptions, swift upload , apurement and DE fees payment -->

              <hr/>
              <div class="flex flex-row flex-wrap" >

                 <div style="float: right; margin-right: 0;">
                    <button pButton type="button"
                            class="p-button-outlined"
                            icon="pi pi-upload" iconPos="left"
                            label="Upload Documents"
                            (click)="openUploadDocumentsDialog()"
                             appRoleVisibility [requiredRoles]="[UserRoleEnum.TradeInitiator, UserRoleEnum.TradeDeskAuthorizer]"
                                               [requiredUserTypes]="[UserType.InternalUser]"
                            style="margin-right: 10px">
                 </button>
                <button pButton type="button"
                            class="p-button-outlined"
                            icon="pi pi-file" iconPos="left"
                            label="Apurement"
                            (click)="openApurementExportationOptionDialog()"
                            appRoleVisibility [requiredRoles]="[UserRoleEnum.TradeDeskAuthorizer]"
                                               [requiredUserTypes]="[UserType.InternalUser]"
                            style="margin-right: 10px">
                 </button>

                    <button pButton
                        type="button"
                        class="p-button-outlined"
                        label="Match DE "
                        icon="pi pi-eye"
                        appRoleVisibility [requiredRoles]="[UserRoleEnum.TradeInitiator]"
                                               [requiredUserTypes]="[UserType.InternalUser]"
                        (click)="openSearchDEDialog()"
                        style="margin-right: 10px">
                      </button>
                 <button pButton
                        type="button"
                        class="p-button-outlined"
                        label="Un Match DE "
                        icon="pi pi-eye-slash"
                        appRoleVisibility [requiredRoles]="[UserRoleEnum.TradeInitiator]"
                                               [requiredUserTypes]="[UserType.InternalUser]"
                        (click)="unmatchDE()"
                        style="margin-right: 10px">
                      </button>
                 <button pButton type="button"
                            class="p-button-outlined"
                            icon="pi pi-wallet" iconPos="left"
                            label="DE Fee Payment"
                            (click)="collectDeFee(exportation.id)"
                            appRoleVisibility [requiredRoles]="[UserRoleEnum.TradeInitiator]"
                                               [requiredUserTypes]="[UserType.InternalUser]"
                            style="margin-right: 10px">
                 </button>

                 <button pButton type="button"
                            class="p-button-outlined"
                            icon="pi pi-arrow-down" iconPos="left"
                            label="Incoming Registration"
                            (click)="incomingRegistrationDialog(exportation)"
                            appRoleVisibility [requiredRoles]="[UserRoleEnum.TradeDeskAuthorizer]"
                                               [requiredUserTypes]="[UserType.InternalUser]"

                            style="margin-right: 10px">
                 </button>

                 <button pButton type="button"
                            class="p-button-outlined"
                            icon="pi pi-arrow-down" iconPos="left"
                            label="Incoming Retrocession"
                            (click)="openIncomingRetrocessionDialog()"
                            appRoleVisibility [requiredRoles]="[UserRoleEnum.TradeDeskAuthorizer]"
                                               [requiredUserTypes]="[UserType.InternalUser]"
                            style="margin-right: 10px">
                 </button>


                <button pButton type="button"
                            class="p-button-outlined"
                            icon="pi pi-exclamation-triangle" iconPos="left"
                            label="Raise Exception"
                            (click)="openRaiseExceptionDialog()"
                            appRoleVisibility [requiredRoles]="[UserRoleEnum.TradeInitiator, UserRoleEnum.TradeDeskAuthorizer]"
                                               [requiredUserTypes]="[UserType.InternalUser]"
                            style="margin-right: 10px">
                  </button>
                   <button pButton type="button"
                            class="p-button-outlined"
                            icon="pi pi-pencil" iconPos="left"
                            [label]="'View/Update Exceptions ('+exportation.exportationExceptionsCount+')'"
                            (click)="openViewExceptionsDialog()"
                            appRoleVisibility  [requiredUserTypes]="[UserType.InternalUser]"
                            style="margin-right: 10px">
                 </button>
                 </div>

               </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Document Review Section -->
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="header">
            <h4 class="title">Documents Review</h4>
            <hr/>
          </div>

          <div class="content">
            <div class="grid">
              <div [ngClass]="{'col-3':panelNumber==2,'col-2':panelNumber==3}"
                   style="border-radius: 6px; border-color: #c42626; border-style:solid; border-width: 1px;">
                <h4 class="title"><strong>Required Documents List</strong></h4>
                <br/>

                <div class="custom-doc-list">
                  <div *ngFor="let doc of documents"
                       (click)="onDocumentChange({ value: doc })"
                       class="doc-item"
                       style="cursor:pointer; padding: 0.55em 0.75em; margin-bottom: 6px; border: 1px solid #dcdcdc; border-radius: 4px;">
                    <i class="pi pi-file" style="font-size: medium; margin-right: 0.5em;"></i>
                    {{doc.documentName}}
                    <br/>
                    <span style="color: #444;">
                      <status [value]="getFileStatusLabel(doc.exportationFileStatus)"
                             [severity]="getStatusSeverity(doc.exportationFileStatus)">
                      </status>
                    </span>
                  </div>
                </div>

                <br/><br/>

                <button pButton pRipple type="button"
                        label="Download Documents"
                        icon="pi pi-download"
                        (click)="downloadZipDocs()"
                        class="p-button-outlined p-button-rounded p-button-primary">
                </button>
                <br/><br/>
                <button pButton pRipple type="button"
                        label="Documents Summary"
                        icon="pi pi-file-pdf"
                        (click)="openDocumentsReviewSummary()"
                        class="p-button-outlined p-button-rounded p-button-primary">
                </button>

                <br/><br/>
              </div>

              <div [ngClass]="{'col-9':panelNumber==2,'col-7':panelNumber==3}"
                   style="border-radius: 6px; border-color: #c42626; border-style:solid; border-width: 1px;">
                <!-- Document Preview Area -->
                <h4 class="title" *ngIf="!selectedDocument" style="color: red;">No Document Selected</h4>
                <div *ngIf="selectedDocument" class="grid row col-12">
                  <div class="col-5">
                    <h4 class="title">
                      <strong>Document Title</strong>: {{ selectedDocument.documentName }}
                    </h4>
                  </div>
                  <div class="col-5">
                    <h4 class="title">
                      <b>Document Status:</b>
                      <status
                             [value]="getFileStatusLabel(selectedDocument.exportationFileStatus)"
                             [severity]="getStatusSeverity(selectedDocument.exportationFileStatus)">
                      </status>
                    </h4>
                  </div>
                  <div class="col-2">
                       <h4 class="title">
                       <button pButton pRipple type="button" style="float: right;"
                              label="Track Doc."
                              (click)="trackDocument()"
                              icon="pi pi-history"
                              class="p-button-outlined p-button-rounded p-button-primary">
                      </button>
                     </h4>
                  </div>

                </div>

                <ngx-extended-pdf-viewer *ngIf="selectedDocument && fileBLob"
                                     [base64Src]="fileBase64"
                                     type="application/pdf"
                                     [height]="'100vh'"
                                     useBrowserLocale="true"
                                     [showHandToolButton]="true"
                                     [textLayer]="true"
                                     (pdfLoadingFailed)="onPdfLoadingFailed($event)"
                                     (pdfLoaded)="onPdfLoaded($event)">
                </ngx-extended-pdf-viewer>

                <div *ngIf="!fileBLob">
                  <h3 style="color: #c42626;">No file found</h3>
                </div>
              </div>

              <!-- Document Controls Panel -->
              <ng-container *ngIf="panelNumber==3">
                <div class="col-3" style="border-radius: 6px; border-color: #c42626; border-style:solid; border-width: 1px;">
                  <h4 *ngIf="!selectedDocument" class="title" style="color: red;">No Document Selected</h4>

                  <div *ngIf="selectedDocument">
                    <h4 class="title"><b>Controls On Document :</b> {{selectedDocument.documentName}}</h4>
                    <hr/>

                    <p *ngIf="documentControls?.length == 0">
                      <b style="color: red;">No controls recorded for this document</b>
                    </p>

                    <h4 *ngIf="documentControls?.length != 0" class="title" style="color: #D32F2F;">Controls to perform: <br/><br/></h4>

                    <ol style="margin: 0;padding-left:15px">
                      <li *ngFor="let control of documentControls" style="padding:0.1rem;font-size:medium">
                        <div class="grid">
                          <div class="col-8" style="cursor: pointer; color:#D32F2F" (click)="viewControlDetails(control)">
                            {{control.documentControlName}}
                          </div>
                          <div class="col-3">
                            <status styleClass="mr-1"
                                  [severity]="colorDocumentControlType(control.documentControlType)"
                                  [value]="getDocumentControlType(control.documentControlType)">
                            </status>
                          </div>
                          <div class="col-1" style="float: left;padding-right: 0; margin-right: 0;">
                            <p-checkbox name="groupcontrol"
                                      [value]="control"
                                      [(ngModel)]="selectedControls"
                                      (onChange)="onControlPerformed($event)"
                                      inputId="document_control_task_id">
                            </p-checkbox>
                          </div>
                        </div>
                      </li>
                    </ol>

                    <div class="grid">
                      <div class="col-12" style="padding: 1em; text-align: center;">
                        <button pButton pRipple type="button"
                                label="Review Document"
                                icon="pi pi-check"
                                [disabled]="!isCheckDocumentEnabled()"
                                (click)="openReviewDialog()"
                                appRoleVisibility [requiredRoles]="[UserRoleEnum.TradeDeskAuthorizer]"
                                                  [requiredUserTypes]="[UserType.InternalUser]"
                                class="p-button-outlined p-button-rounded p-button-success">
                        </button> <br/>
                        <div *ngIf="selectedComplemetaryInformationRequiredFor == ComplemetaryInformationRequiredFor.FinalInvoice">
                          <button pButton pRipple type="button"
                                  label="Update Facture Definitive"
                                  icon="pi pi-check"
                                  [disabled]="fileBLob == null"
                                  appRoleVisibility [requiredRoles]="[UserRoleEnum.TradeDeskAuthorizer]"
                                                                            [requiredUserTypes]="[UserType.InternalUser]"
                                  (click)="openUpdateFactureDefinitiveDialog()"
                                                          class="p-button-outlined p-button-rounded p-button-success mt-3">
                          </button>
                        </div>
                        <div *ngIf="selectedComplemetaryInformationRequiredFor == ComplemetaryInformationRequiredFor.GoodForEmbacation">
                          <button pButton pRipple type="button"
                                label="Update Bon pour Embarquement"
                                icon="pi pi-check"
                                 [disabled]="fileBLob == null"
                                appRoleVisibility [requiredRoles]="[UserRoleEnum.TradeDeskAuthorizer]"
                                                  [requiredUserTypes]="[UserType.InternalUser]"
                                (click)="openUpdateBonEmbarquementDialog()"
                                class="p-button-outlined p-button-rounded p-button-success mt-3">
                        </button>
                        </div>

                      </div>
                    </div>
                  </div>
                         <hr/>
                   <div appRoleVisibility [requiredUserTypes]="[UserType.InternalUser]">
                    <div style="margin: auto;width: 50%;">
                          <button pButton pRipple type="button" label="Exportation Audit"  icon="pi pi-history"
                          (click)="getExportationMessages()"
                          class="p-button-outlined p-button-rounded p-button-primary">
                          </button>
                    </div>
                    <div class="container scroller-activity">

                        <div *ngFor="let item of exportationMessages" class="timeline-item">
                            <div style="position: absolute;left:2em;font-weight: bold;top: 1em;display: block;font-family: 'Roboto', sans-serif;font-weight: 700;font-size: .885rem;color: brown;">
                                {{item.createdDate | date :'medium'}} - By {{item.createdBy}}
                            </div>
                            <h5 style="margin-top: 0;">
                              <status [value]="getExportationMessageType(item.exportationMessageType)"
                               [severity]="'info'" ></status> -
                              <status [value]="getExportationMessageTypeName(item.messageType)"
                              [severity]="getExportationMessageTypeColor(item.messageType)" >
                              </status></h5>
                            <p [innerHTML]="item.message">
                            </p>
                        </div>

                    </div>
                   </div>
                </div>
              </ng-container>

               <!-- Action Buttons -->

              <div class="flex flex-row flex-wrap mt-3">
                <button pButton type="button"
                        class="p-button-outlined p-button-success"
                        icon="pi pi-check" iconPos="left"
                        label="Submit"
                        (click)="submitExportation()"
                        appAdminRole
                                [Roles]="[
                                UserRoles.TradeInitiator.toString()]"
                        *ngIf="exportation?.exportationStatus == ExportationStatus.ExportationDrafted"
                        style="margin-right: 10px;">
                </button>
                <button pButton type="button"
                        class="p-button-outlined p-button-danger"
                        icon="pi pi-trash" iconPos="left"
                        label="Delete"
                        (click)="deleteExportation()"
                        appAdminRole
                                [Roles]="[
                                UserRoles.TradeInitiator.toString()]"
                        style="margin-right: 10px;">
                </button>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>

  </div>

  <!-- Document Review Dialog -->
  <p-dialog [(visible)]="reviewDialog"
            [style]="{width: '50vw'}"
            [header]="'Review Document - ' + selectedDocument?.documentName"
            [modal]="true">
    <br/>
            <br/>
            <form [formGroup]="reviewForm" (ngSubmit)="submitReview()" class="p-fluid">
              <div class="grid">
                <!-- Status -->
                <div class="col-12 mb-3">
                  <span class="p-float-label">
                    <p-dropdown formControlName="exportationFileStatus"
                              [options]="documentReviewStatus"
                              [style]="{'width':'100%'}"
                              optionLabel="label"
                              optionValue="value"
                              placeholder="Select Status"
                              [showClear]="false">
                    </p-dropdown>
                    <label>Review Status</label>
                  </span>
                </div>

                <!-- Review Note -->
                <div class="col-12 mb-3">
                 <!--  <span class="p-float-label">
                    <textarea pInputTextarea
                             formControlName="reviewerNote"
                             [rows]="4"
                             [style]="{'width':'100%','font-size':'1.2em'}"
                             autoResize="true">
                    </textarea>
                     <label>Review Notes</label>
                  </span> -->
                  <label>Review Notes</label>
                   <p-editor formControlName="reviewerNote"[style]="{ height: '200px' }">
                        <ng-template pTemplate="header">
                           <span class="ql-formats">
                          <select class="ql-size">
                            <option value="small">Small</option>
                            <option value="large">Large</option>
                            <option value="huge">Big</option>
                          </select>
                        </span>
                        <span class="ql-formats">
                          <button type="button" class="ql-bold" aria-label="Bold"></button>
                          <button type="button" class="ql-italic" aria-label="Italic"></button>
                          <button type="button" class="ql-underline" aria-label="Underline"></button>
                        </span>
                        <span class="ql-formats">
                          <button type="button" class="ql-list" value="ordered" aria-label="Ordered List"></button>
                          <button type="button" class="ql-list" value="bullet" aria-label="Unordered List"></button>
                        </span>
                      </ng-template>
                   </p-editor>
                </div>

                <!-- Submit Button -->
                <div class="col-12">
                  <button pButton type="submit"
                          label="Submit Review"
                          icon="pi pi-check"
                          [disabled]="reviewForm.invalid"
                          class="p-button-success">
                  </button>
                </div>
              </div>
            </form>
  </p-dialog>

   <!-- Raise Exception Dialog -->
  <p-dialog [(visible)]="raiseExceptionDialog"
                    [style]="{width: '60vw'}"
                    [header]="'Raise Exception - ' + exportation?.exportationReference"
                    [modal]="true">
                    <br/><br/>
            <form [formGroup]="exceptionForm" (ngSubmit)="submitException()" class="p-fluid">
              <div class="grid">
                <!-- Exception Directed To -->
                <div class="col-6 mb-3">
                  <span class="p-float-label">
                    <p-dropdown formControlName="exceptionDirectedTo"
                              [options]="directedToOptions"
                              [style]="{'width':'100%'}"
                              optionLabel="label"
                              optionValue="value"
                              placeholder="Select Target">
                    </p-dropdown>
                    <label>Direct Exception To</label>
                  </span>
                </div>

                <!-- Severity -->
                <div class="col-6 mb-3">
                  <span class="p-float-label">
                    <p-dropdown formControlName="severity"
                              [options]="severityOptions"
                              [style]="{'width':'100%'}"
                              optionLabel="label"
                              optionValue="value"
                              placeholder="Select Severity">
                    </p-dropdown>
                    <label>Severity</label>
                  </span>
                </div>

                <!-- Exception Resolver Email -->
                <div class="col-12 mb-3">
                  <span class="p-float-label">
                      <p-multiSelect formControlName="exceptionResolverEmail"
                                 [options]="contactOfExceptionResolver"
                                 optionLabel="email"
                                 optionValue="email"
                                 [filter]="true"
                                 (onClick)="getContactOfExceptionResolver()"
                                 placeholder="Select Exception Resolver">
                      <ng-template let-contact pTemplate="item">
                        <div class="flex align-items-center gap-2">
                          <div>{{contact.email}} - </div>
                          <div>{{contact.contactName}} - </div>
                          <div>{{contact.contactPosition}}</div>
                        </div>
                      </ng-template>
                    </p-multiSelect>
                    <label>Exception Resolver Email</label>
                  </span>
                </div>

                <!-- Related Documents -->
                <div class="col-9 mb-3">
                  <span class="p-float-label">
                    <p-multiSelect formControlName="exportationFileCausingException"
                                 [options]="documents"
                                 optionLabel="documentName"
                                 optionValue="id"
                                 [filter]="true"
                                 placeholder="Select Related Documents">
                      <ng-template let-doc pTemplate="item">
                        <div class="flex align-items-center gap-2">
                          <div>{{doc.documentName}}</div>
                          <status [value]="getFileStatusLabel(doc.exportationFileStatus)"
                                [severity]="getStatusSeverity(doc.exportationFileStatus)">
                          </status>
                        </div>
                      </ng-template>
                    </p-multiSelect>
                    <label>Related Documents</label>
                  </span>
                </div>
                 <div class="col-3 mb-3">
                  <span class="p-float-label">
                    <p-checkbox formControlName="isExportationFileReviewNoteAdded"
                           [binary]="true" value="true"
                           inputId="isExportationFileReviewNoteAdded">
                    </p-checkbox>

                    <label for="isExportationFileReviewNoteAdded" class="ml-4">Add Documents Review Notes</label>
                  </span>
                </div>

                <!-- Internal Note -->
                <div class="col-12 mb-3">
                   <label>Internal Note</label>
                    <p-editor formControlName="internalNote" [style]="{ height: '160px' }"></p-editor>
              <!--     <span class="p-float-label">
                    <textarea pInputTextarea
                             formControlName="internalNote"
                             [rows]="3"
                             [style]="{'width':'100%', 'font-size':'1.5em'}"
                             autoResize="true">
                    </textarea>
                    <label>Internal Note</label>

                  </span> -->
                </div>

                <!-- Client Note -->
                <div class="col-12 mb-3">
                  <label>Client Note</label>
                  <p-editor formControlName="clientNote" [style]="{ height: '160px' }"></p-editor>
                 <!--  <span class="p-float-label">
                    <textarea pInputTextarea
                             formControlName="clientNote"
                             [rows]="3"
                             [style]="{'width':'100%', 'font-size':'1.5em'}"
                             autoResize="true">
                    </textarea>
                    <label>Client Note</label>
                  </span> -->
                </div>

                <!-- Submit Button -->
                <div class="col-12">
                  <button pButton type="submit"
                          label="Raise Exception"
                          icon="pi pi-exclamation-triangle"
                          class="p-button-danger"
                          [disabled]="exceptionForm.invalid">
                  </button>
                </div>
              </div>
            </form>
          </p-dialog>
  <!-- Delete Confirmation Dialog -->
  <swal #dialog_operation_swal
        title="Delete ?"
        text="This cannot be undone"
        icon="question"
        [showCloseButton]="true">
  </swal>

  <!-- Upload Documents Dialog -->
  <p-dialog [(visible)]="uploadDocumentsDialog"
          [style]="{width: '70vw'}"
          [header]="'Upload Documents - ' + exportation?.exportationReference"
          [modal]="true">
  <p-table [value]="documents"
           [responsive]="true"
           styleClass="p-datatable-sm p-datatable-gridlines">
    <ng-template pTemplate="header">
      <tr>
        <th>Document Name</th>
        <th>Status</th>
        <th>Submission Option</th>
        <th>Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-doc>
      <tr [class.selected-row]="selectedUploadDocument?.id === doc.id">
        <td>{{doc.documentName}}</td>
        <td>
          <status [value]="getFileStatusLabel(doc.exportationFileStatus)"
                 [severity]="getStatusSeverity(doc.exportationFileStatus)">
          </status>
        </td>
        <td>
           <status [value]="getDocumentSubmissionStatusLabel(doc.documentSubmissionOption)"
                 [severity]="getDocumentSubmissionSeverity(doc.documentSubmissionOption)">
           </status>
        </td>
        <td>
          <div class="flex gap-2">
            <button pButton
                    type="button"
                    label="Select for Upload"
                    icon="pi pi-upload"
                    class="p-button-outlined p-button-primary"
                    (click)="selectDocumentForUpload(doc)">
            </button>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <div class="mt-4" *ngIf="selectedUploadDocument">
    <h5>Upload Document: {{selectedUploadDocument.documentName}}</h5>
    <div class="grid">
      <div class="col-8">
        <input type="file"
               class="p-inputtext w-full"
               (change)="onFileSelected($event)"
               accept=".pdf">
      </div>
      <div class="col-4">
        <button pButton
                type="button"
                label="Upload"
                icon="pi pi-upload"
                [disabled]="!selectedFile"
                (click)="uploadDocument()"
                class="p-button-success">
        </button>
      </div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <button pButton
            type="button"
            label="Close"
            icon="pi pi-times"
            (click)="uploadDocumentsDialog = false"
            class="p-button-outlined">
    </button>
  </ng-template>
</p-dialog>

  <!-- Update Facture Definitive Dialog -->
  <p-dialog [(visible)]="updateFactureDefinitiveDialog"
            [style]="{width: '40vw'}"
            header="Update Facture Définitive"
            [modal]="true">

            <br/>

    <form [formGroup]="updateFactureDefinitiveForm" (ngSubmit)="submitUpdateFactureDefinitive()" class="p-fluid">
      <div class="grid">
        <div class="col-12 mb-3">
          <span class="p-float-label">
            <input pInputText formControlName="referenceFactureDefinitive" />
            <label>Reference Facture Définitive</label>
          </span>
        </div>
        <div class="col-12 mb-3">
          <span class="p-float-label">
            <input pInputText type="number" formControlName="amountFactureDefinitive" />
            <label>Amount Facture Définitive</label>
          </span>
        </div>
        <div class="col-12">
          <button pButton type="submit" label="Save" icon="pi pi-check" [disabled]="updateFactureDefinitiveForm.invalid" class="p-button-success"></button>
        </div>
      </div>
    </form>
  </p-dialog>

  <!-- Update Bon pour Embarquement Dialog -->
  <p-dialog [(visible)]="updateBonEmbarquementDialog"
            [style]="{width: '40vw'}"
            header="Update Bon pour Embarquement"
            [modal]="true">

             <br/>

    <form [formGroup]="updateBonEmbarquementForm" (ngSubmit)="submitUpdateBonEmbarquement()" class="p-fluid">
      <div class="grid">
        <div class="col-12 mb-3">
          <span class="p-float-label">
            <input pInputText formControlName="referenceBonForEmbarquement" />
            <label>Reference Bon pour Embarquement</label>
          </span>
        </div>
        <div class="col-12 mb-3">
          <span class="p-float-label">
            <input pInputText type="number" formControlName="amountBonForEmbarquement" />
            <label>Amount Bon pour Embarquement</label>
          </span>
        </div>
        <div class="col-12 mb-3">
          <span class="p-float-label">
            <p-calendar formControlName="dateBonForEmbarquement" inputId="dateBonForEmbarquement" dateFormat="yy-mm-dd" [showIcon]="true"></p-calendar>
            <label for="dateBonForEmbarquement">Date Bon pour Embarquement</label>
          </span>
        </div>
        <div class="col-12">
          <button pButton type="submit" label="Save" icon="pi pi-check" [disabled]="updateBonEmbarquementForm.invalid" class="p-button-success"></button>
        </div>
      </div>
    </form>
  </p-dialog>

<!-- Incoming Retrocession Dialog -->
<p-dialog [(visible)]="incomingRetrocessionDialog"
          [style]="{width: '40vw'}"
          [header]="'Register Incoming Retrocession'"
          [modal]="true">
          <br/><br/>
  <form [formGroup]="incomingRetrocessionForm" class="p-fluid">
    <div class="grid">
      <div class="col-12 mb-3">
        <span class="p-float-label">
          <input pInputText formControlName="refundReference">
          <label>Refund Reference</label>
        </span>
      </div>

      <div class="col-12 mb-3">
        <span class="p-float-label">
          <input pInputText type="number" step="0.01" formControlName="amountThatShouldBeRefund">
          <label>Amount To Refund</label>
        </span>
      </div>

      <div class="col-12 mb-3">
        <div class="p-field">
          <label class="mb-2">Swift File (.txt) *</label>
          <input type="file"
                 class="p-inputtext w-full"
                 (change)="onIncomingRetrocessionSwiftSelected($event)"
                 accept=".txt">
          <small class="p-error block mt-1" *ngIf="selectedIncomingRetrocessionSwiftFile">
            Selected file: {{selectedIncomingRetrocessionSwiftFile.name}}
          </small>
        </div>
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <button pButton
            type="button"
            label="Register"
            icon="pi pi-check"
            [disabled]="!incomingRetrocessionForm.valid || !selectedIncomingRetrocessionSwiftFile"
            (click)="submitIncomingRetrocessionRegistration()"
            class="p-button-success">
    </button>
    <button pButton
            type="button"
            label="Close"
            icon="pi pi-times"
            (click)="incomingRetrocessionDialog = false"
            class="p-button-outlined">
    </button>
  </ng-template>
</p-dialog>

<p-dialog [(visible)]="documentHistoryDialog"
          [style]="{width: '50vw'}"
          [header]="'Document History'"
          [modal]="true">
    <div class="container scroller-activity">
        <div *ngFor="let item of documentHistory" class="timeline-item">
            <div style="position: absolute;left:2em;font-weight: bold;top: 1em;display: block;font-family: 'Roboto', sans-serif;font-weight: 700;font-size: .885rem;color: brown;">
                {{item.lastUpdatedDate | date :'medium'}} - {{item.lastUpdateBy}}
            </div>
            <h5 style="margin-top: 0;">
                <status [value]="getDocumentHistoryStatus(item.exportationFileStatus)"
                      [severity]="colorDocumentHistoryStatus(item.exportationFileStatus)">
                </status>
            </h5>
            <p>
                <strong>Document Name:</strong><br/>
                {{item.documentName}}
            </p>
            <strong>Review Note:</strong><br/>
            <div [innerHTML]="item.reviewNote || 'No notes'"></div>
            <p *ngIf="item.documentPath && item.documentPath.length > 0">
                <strong>Attached Document:</strong><br/>
                <a (click)="downloadHistoryDocument(item.exportationId, item.id, item.history, item.documentName)"
                   style="cursor: pointer;">Download</a>
            </p>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <button pButton type="button"
                label="Close"
                class="p-button-outlined p-button-danger"
                icon="pi pi-times"
                (click)="documentHistoryDialog = false">
        </button>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="apurementExportationOptionDialog"
          [style]="{width: '50vw',height: '35vh'}"
          [header]="'Set Apurement Status'"
          [modal]="true">
     <br/>
  <div class="grid">
      <div class="col-12">
                <span class="p-float-label">
                    <p-dropdown [(ngModel)]="selectedApurementExportationOption"
                                [options]="apurementExportationOption"
                                [style]="{'width':'100%'}"
                                optionLabel="label"
                                optionValue="value"
                                placeholder="Select Apurement Status"
                                [showClear]="false">
                    </p-dropdown>
                    <label>Apurement Status</label>
                </span>
      </div>
    </div>
    <br/> <br/> <br/> <br/>

    <ng-template pTemplate="footer">
        <button pButton type="button"
                label="Submit"
                class="p-button-outlined"
                (click)="submitApurementExportationOption()">
        </button>
        <button pButton type="button"
                label="Close"
                class="p-button-outlined"
                (click)="apurementExportationOptionDialog = false">
        </button>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="incomingDialog"
          [style]="{width: '50vw'}"
          [header]="'Register Incoming'"
          [modal]="true">
  <form [formGroup]="incomingForm" class="p-fluid">
    <div class="grid">
      <!-- File Upload -->
      <div class="col-12 mb-3">
        <div class="p-field">
          <label class="mb-2">Swift File (.txt) *</label>
          <input type="file"
                 class="p-inputtext w-full"
                 (change)="onIncomingSwiftSelected($event)"
                 accept=".txt">
          <small class="p-error block mt-1" *ngIf="selectedIncomingSwiftFile">
            Selected file: {{selectedIncomingSwiftFile.name}}
          </small>
        </div>
      </div>

      <!-- Parsed Data Fields -->
      <div class="col-6 mb-3">
        <span class="p-float-label">
          <input pInputText
                 formControlName="accountNumber"
                 [readonly]="true">
          <label>Account Number</label>
        </span>
      </div>

      <div class="col-3 mb-3">
        <span class="p-float-label">
          <input pInputText
                 formControlName="amount"
                 [readonly]="true">
          <label>Amount</label>
        </span>
      </div>

      <div class="col-3 mb-3">
        <span class="p-float-label">
          <input pInputText
                 formControlName="currency"
                 [readonly]="true">
          <label>Currency</label>
        </span>
      </div>

       <div class="col-6 mb-3">
        <span class="p-float-label">
          <input pInputText
                 formControlName="swiftReference"
                 [readonly]="true">
          <label>Swift Reference</label>
        </span>
      </div>

      <div class="col-6 mb-3">
        <span class="p-float-label">
          <input pInputText
                 formControlName="valueDate"
                 [readonly]="true">
          <label>Value Date</label>
        </span>
      </div>

      <div class="col-12 mb-3">
        <span class="p-float-label">
          <textarea pInputTextarea style="width: 100%; font-size: 1.5em"
                   formControlName="beneficiaryNameAddress"
                   [rows]="4"
                   [readonly]="true">
          </textarea>
          <label>Beneficiary Name & Address</label>
        </span>
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <button pButton
            type="button"
            label="Register"
            icon="pi pi-check"
            [disabled]="!selectedIncomingSwiftFile || !incomingForm.valid"
            (click)="submitIncomingRegistration()"
            class="p-button-success">
    </button>
    <button pButton
            type="button"
            label="Close"
            icon="pi pi-times"
            (click)="incomingDialog = false"
            class="p-button-outlined">
    </button>
  </ng-template>
</p-dialog>

<!-- Add before the last closing div -->
<p-dialog [(visible)]="viewExceptionsDialog"
          [style]="{width: '80vw'}"
          [header]="'Exportation Exceptions - ' + exportation?.exportationReference"
          [modal]="true">
  <p-table [value]="transactionExceptions"
          [expandedRowKeys]="expandedRows"
          dataKey="id"
          styleClass="p-datatable-gridlines"
          [paginator]="true"
          [rows]="10"
          [showCurrentPageReport]="true"
          responsiveLayout="scroll">
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem"></th>
        <th>N°</th>
        <th>Directed To</th>
        <th>Exception Resolver</th>
        <th>Attachment</th>
        <th>Status</th>
        <th>Severity</th>
        <th>Created Date</th>
        <th>Exception Raiser</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-exception let-expanded="expanded">
      <tr>
        <td>
          <button type="button" pButton pRipple
                  [pRowToggler]="exception"
                  class="p-button-text p-button-rounded p-button-plain"
                  [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'">
          </button>
        </td>
        <td>E-{{exception.exceptionSerialNumber}}</td>
        <td>
          <status [value]="getExceptionDirectedToLabel(exception.exceptionDirectedTo)"
                severity="info">
          </status>
        </td>
        <td>
          <div class="flex flex-column">
            <small *ngFor="let resolver of exception.exceptionResolver">
              {{resolver}}
            </small>
          </div>
        </td>
        <td>
          {{exception?.attachedEmail == null || exception?.attachedEmail == undefined || exception?.attachedEmail == '' ? 'No Attachment' : 'File Attached'}}
        </td>
        <td>
          <status [value]="getExceptionStatusLabel(exception.exceptionStatus)"
                [severity]="colorExceptionStatus(exception.exceptionStatus)">
          </status>
        </td>
        <td>
          <status [value]="getExceptionSeverityToLabel(exception.severity)"
                [severity]="colorExceptionSeverity(exception.severity)">
          </status>
        </td>
        <td>{{exception.dateCreated | date:'MMM dd, yyyy HH:mm:ss'}}</td>
        <td>{{exception.exceptionRaiserName}}</td>
      </tr>
    </ng-template>
    <ng-template pTemplate="rowexpansion" let-exception>
      <tr>
        <td colspan="9">
          <div class="p-3">
            <div class="grid">
              <div class="col-6">
                <h6>Internal Note</h6>
                  <p [style.maxHeight]="'225px'" class="overflow-auto"
                     [innerHTML]="exception.internalNote">
                  </p>
                <!-- <p-editor
                          [style]="{height: '160px', width: '100%'}"
                          [ngModel]="exception.internalNote"
                          [readonly]="true"></p-editor> -->
              </div>
              <div class="col-6">
                <h6>Client Note</h6>
                  <p [style.maxHeight]="'225px'" class="overflow-auto"
                     [innerHTML]="exception.clientNote">
                  </p>
                <!-- <p-editor
                          [style]="{height: '160px', width: '100%'}"
                          [ngModel]="exception.clientNote"
                          [readonly]="true"></p-editor> -->

              </div>
              <div class="col-6">
                <h6>Related Documents</h6>
                <ul>
                  <li *ngFor="let docId of exception.exportationFileCausingException">
                    {{getDocumentName(docId)}}
                  </li>
                </ul>
              </div>
              <div class="col-12">
                          <p *ngIf="exception.attachedEmail">
                              <strong>Attached Email:</strong><br/>
                              <a (click)="downloadAttachedEmail(exception)"
                                style="cursor: pointer;" >Download</a>
                          </p>
                        </div>
            </div>
          </div>
          <hr/>
          <div class="flex flex-row flex-wrap reverse">
            <button pButton type="button"
                    class="p-button-outlined"
                    icon="pi pi-pencil" iconPos="left"
                    label="Update Exception"
                    (click)="openUpdateExceptionDialog(exception)"
                    style="margin-right: 10px">
            </button>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-dialog>

<p-dialog [(visible)]="updateExceptionDialog"
          [style]="{width: '50vw'}"
          [header]="'Update Exception Status'"
          [modal]="true">
  <form [formGroup]="updateExceptionForm" (ngSubmit)="submitUpdateException()" class="p-fluid">
    <br/><br/>
    <div class="grid">
      <!-- Status -->
      <div class="col-12 mb-3">
        <span class="p-float-label">
          <p-dropdown formControlName="exceptionStatus"
                    [options]="exceptionStatusOptions"
                    [style]="{'width':'100%'}"
                    optionLabel="label"
                    optionValue="value"
                    [showClear]="false">
          </p-dropdown>
          <label>Exception Status</label>
        </span>
      </div>

      <!-- Internal Note -->
      <div class="col-12">
        <!-- <span class="p-float-label">
          <textarea pInputTextarea
                   formControlName="internalNote"
                   [rows]="4"
                   [style]="{'width':'100%', 'font-size':'1.2em'}"
                   autoResize="true">
          </textarea>
          <label>Internal Note</label>
        </span> -->
         <label>Internal Note</label>
         <p-editor #internalNoteEditorForUpdateExceptionStatus
                   formControlName="internalNote"
                   [style]="{ height: '200px' }">
                   <ng-template pTemplate="header">
                     <span class="ql-formats">
                          <select class="ql-size">
                            <option value="small">Small</option>
                            <option value="large">Large</option>
                            <option value="huge">Big</option>
                          </select>
                        </span>
                  <span class="ql-formats">
                    <button type="button" class="ql-bold" aria-label="Bold"></button>
                    <button type="button" class="ql-italic" aria-label="Italic"></button>
                    <button type="button" class="ql-underline" aria-label="Underline"></button>
                  </span>
                  <span class="ql-formats">
                    <button type="button" class="ql-list" value="ordered" aria-label="Ordered List"></button>
                    <button type="button" class="ql-list" value="bullet" aria-label="Unordered List"></button>
                  </span>
                </ng-template>
         </p-editor>
      </div>

      <!-- File Attachment -->
      <div class="col-12 mb-3">
        <div class="p-field">
          <label class="mb-2">Attach File (optional)</label>
          <input type="file"
                 class="p-inputtext w-full"
                 (change)="onFileSelected($event)"
                 accept=".pdf,.doc,.docx,.xls,.xlsx">
          <small class="p-error block mt-1" *ngIf="selectedFile">
            Selected file: {{selectedFile.name}}
          </small>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="col-12">
        <button pButton type="submit"
                label="Update Exception"
                icon="pi pi-save"
                [disabled]="updateExceptionForm.invalid"
                class="p-button-success">
        </button>
      </div>
    </div>
  </form>
</p-dialog>

   <!-- Documents Review Summary Dialog -->
          <p-dialog [(visible)]="documentsReviewDialog"
                    [style]="{width: '80vw'}"
                    [header]="'Documents Review Summary - ' + exportation?.exportationReference"
                    [modal]="true">

            <p-table [value]="documents"
                     styleClass="p-datatable-gridlines p-datatable-striped"
                     [paginator]="true"
                     [rows]="10"
                     [showCurrentPageReport]="true"
                     responsiveLayout="scroll">
              <ng-template pTemplate="header">
                <tr>
                  <th style="width: 250px; min-width: 250px;">Document Name</th>
                  <th>Review Note</th>
                  <th style="width: 220px; min-width: 270px;" >Status</th>
                  <th style="width: 250px; min-width: 220px;">Document Submission Option </th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-doc>
                <tr>
                  <td>{{doc.documentName}}</td>
                    <td>
                    <p [style.maxHeight]="'60px'" class="overflow-auto" [innerHTML]="doc.reviewNote || 'No review note'">
                    </p>
                  </td>
                  <td>
                    <status [value]="getFileStatusLabel(doc.exportationFileStatus)"
                          [severity]="getStatusSeverity(doc.exportationFileStatus)">
                    </status>
                  </td>

                  <td>
                    <status [value]="getDocumentSubmissionStatusLabel(doc.documentSubmissionOption)"
                          [severity]="getDocumentSubmissionSeverity(doc.documentSubmissionOption)">
                    </status>
                  </td>

                </tr>
              </ng-template>
              <ng-template pTemplate="emptymessage">
                <tr>
                  <td colspan="5" class="text-center">No documents found</td>
                </tr>
              </ng-template>
            </p-table>

            <ng-template pTemplate="footer">
              <button pButton type="button"
                      label="Close"
                      class="p-button-outlined"
                      (click)="documentsReviewDialog = false">
              </button>
            </ng-template>
          </p-dialog>
 <!-- Search DE Dialog -->
          <p-dialog [(visible)]="searchDEDialog"
            [style]="{width: '50vw', height: '60vh'}"
            header="Search DE"
            [modal]="true">
            <form [formGroup]="searchDEForm">
              <div class="grid p-fluid">
                <!-- DE Reference Search -->
                <div class="col-12">
                <br/> <br/>
                  <span class="p-float-label">
                    <input pInputText formControlName="eForceReference" />
                    <label>eForce Reference</label>
                  </span>
                </div>

                <!-- Search Button -->
                <div class="col-12 mt-3">
                  <button pButton type="button"
                    label="Search"
                    class="p-button-outlined"
                    (click)="searchDE()"
                    [disabled]="!searchDEForm.valid">
                  </button>
                </div>

                <!-- DE Details Display -->
                <div class="col-12 mt-3" *ngIf="selectedDEDetails">
                  <p-fieldset header="DE Details">
                    <div class="grid">
                      <div class="col-6"><strong>Docmiciliation Number:</strong> {{selectedDEDetails.domiciliationReference}}</div>
                      <div class="col-6"><strong>Docmiciliation Date:</strong> {{selectedDEDetails.domiciliationDate | date}}</div>
                      <div class="col-6"><strong>File Number:</strong> {{selectedDEDetails.fileNumber}}</div>
                      <div class="col-6"><strong>Place of Destination:</strong> {{selectedDEDetails.placeOfDestination}}</div>
                      <div class="col-6"><strong>Provider:</strong> {{selectedDEDetails.provider}}</div>
                      <div class="col-6"><strong>Buyer:</strong> {{selectedDEDetails.buyer}}</div>
                      <div class="col-6"><strong>Request Date:</strong> {{selectedDEDetails.requestDate | date}}</div>
                      <div class="col-6"><strong>Bank:</strong> {{selectedDEDetails.bank}}</div>
                      <div class="col-6"><strong>FOB Value:</strong> {{selectedDEDetails.fobValueCfa | number}} CFA</div>
                    </div>
                  </p-fieldset>
                </div>
              </div>
            </form>

            <ng-template pTemplate="footer">
              <button pButton type="button"
                label="Cancel"
                class="p-button-outlined p-button-secondary"
                (click)="searchDEDialog = false">
              </button>
              <button pButton type="button"
                label="Confirm"
                class="p-button-outlined p-button-success ml-2"
                [disabled]="!selectedDEDetails"
                (click)="matchDESelection()">
              </button>
            </ng-template>
          </p-dialog>
</div>
